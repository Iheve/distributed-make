DIADIR=dia
IMGDIR=img
IMGSTDIR=img_static
TEXDIR=tex
PDFDIR=pdf
INCDIR=include
COMPDIR=.compil
GITFILE=$(COMPDIR)/gitfile.tex

DIA=$(wildcard $(DIADIR)/*.dia)
IMG=$(addprefix $(IMGDIR)/, $(notdir $(DIA:%.dia=%.tex)))
IMGST=$(wildcard $(IMGSTDIR)/*)
DEP=$(wildcard $(INCDIR)/*.tex)
TEX=$(wildcard $(TEXDIR)/*.tex)
FILES=$(addprefix $(PDFDIR)/, $(notdir $(TEX:%.tex=%.pdf)))

DIRGUARD=mkdir -p $(COMPDIR) $(IMGDIR) $(PDFDIR)
LATEX=pdflatex -output-directory=$(COMPDIR) $<

.SECONDARY: $(IMG)

all: $(FILES)

echo:
	@echo $(IMG)
	@echo $(DIA)
	@echo $(DEP)
	@echo $(TEX)
	@echo $(FILES)


$(IMGDIR)/%.png: $(DIADIR)/%.dia
	$(DIRGUARD)
ifeq ($(TUX), true)
	cp img_static/tux.png $@
else
	dia -e $@ -t png-libart $<
endif

$(IMGDIR)/%.pdf: $(DIADIR)/%.dia
	$(DIRGUARD)
	dia -s 800x -e $@ -t pdf $<

$(IMGDIR)/%.tex: $(DIADIR)/%.dia
	$(DIRGUARD)
	dia -e $@ -t pgf-tex $<

$(IMGDIR)/%.svg: $(DIADIR)/%.dia
	$(DIRGUARD)
	dia -e $@ -t svg $<

$(PDFDIR)/%.pdf: $(TEXDIR)/%.tex $(DEP) $(IMG) $(IMGST)
	$(DIRGUARD)
	$(LATEX) -draft && $(LATEX)
	mv $(COMPDIR)/$(notdir $@) $@

$(GITFILE): .git/logs/HEAD
	$(DIRGUARD)
	echo "%%% This file is generated by Makefile." > $@
	echo "%%% Do not edit this file!\n%%%" >> $@
	git log -1 --format="format:\
		\\gdef\\GITAbrHash{%h}\
		\\gdef\\GITAuthorDate{%aD}\
		\\gdef\\GITAuthorName{%an}" >> $@

view: $(FILES)
	@if ! zathura $^ 2> /dev/null; then if ! okular $^ 2> /dev/null; then if ! open $^ 2> /dev/null; then evince $^ 2> /dev/null; fi fi fi &

clean:
	rm -rf $(COMPDIR) $(IMGDIR)

realclean: clean
	rm -rf $(PDFDIR)
